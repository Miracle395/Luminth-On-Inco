<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <link rel="icon" href="stablex.png" type="image/png" sizes="16x16" />

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Manrope:wght@600;700;800&display=swap" rel="stylesheet">

  <!-- Bootstrap -->
  <link
    rel="stylesheet"
    href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
    integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
    crossorigin="anonymous"
  />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="luminth.css" />

  <title>A smarter way to grow your stable assets.</title>

  <style>
    .loading-spinner {
      border: 2px solid #f3f3f3;
      border-top: 2px solid #00ff90;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 0.8s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-left: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none; }
  </style>
</head>

<body>

  <!-- NAVBAR -->
  <nav class="navbar navbar-dark">
    <a class="navbar-brand d-flex align-items-center" href="/">
      <img src="luminth2.png" style="width:40px" alt="Luminth Logo" />
    </a>
    <button id="accountBtn" class="account-btn" type="button">
      <span id="accountLabel">Connect Wallet</span>
    </button>
  </nav>

  <!-- STAKING CARD -->
  <section class="staking-card container mt-4">

    <div class="staking-toggle mb-3">
      <button id="stakeTab" class="tab active" type="button">Stake</button>
      <button id="unstakeTab" class="tab" type="button">Unstake</button>
    </div>

    <!-- STAKE SECTION -->
    <div id="stakeSection">
      <h4>Stake USDC</h4>
      <div class="form-group">
        <label>Amount to Stake</label>
        <input type="number" id="stakeInput" placeholder="0.0 USDC" class="form-control" />
      </div>
      <button id="depositButton" class="btn btn-success">Add funds</button>
      <p>Your sUSDC balance: <span id="sUSDCBalance">0.00</span></p>
    </div>

    <!-- UNSTAKE SECTION -->
    <div id="unstakeSection" class="hidden">
      <h4>Unstake sUSDC</h4>
      <div class="form-group">
        <label>Amount to Unstake</label>
        <input type="number" id="unstakeInput" placeholder="0.0 sUSDC" class="form-control" />
      </div>
      <button id="unstakeButton" class="btn btn-warning">Withdraw</button>
    </div>

  </section>

  <script type="module">
    import { Connection, clusterApiUrl } from "https://esm.sh/@solana/web3.js@1.98.0";

    const connection = new Connection(clusterApiUrl("devnet"), "confirmed");
    let walletPublicKey = null;

    /* ================= WALLET ================= */
    async function connectWallet() {
      if (!window.solana) return alert("Install Phantom or Solflare");
      const res = await window.solana.connect();
      walletPublicKey = res.publicKey;
      document.getElementById("accountLabel").textContent =
        walletPublicKey.toBase58().slice(0,4) + "…" + walletPublicKey.toBase58().slice(-4);
      await syncPrivateBalance();
    }

    async function disconnectWallet() {
      await window.solana.disconnect();
      walletPublicKey = null;
      document.getElementById("accountLabel").textContent = "Connect Wallet";
      document.getElementById("sUSDCBalance").textContent = "0.00";
    }

    /* ================= BALANCES ================= */
    async function syncPrivateBalance() {
      if (!walletPublicKey) return;
      const res = await fetch("/api/balance", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ wallet: walletPublicKey.toBase58() })
      });
      const data = await res.json();
      document.getElementById("sUSDCBalance").textContent = (data.balance / 1e6).toFixed(2);
    }

    /* ================= STAKE / UNSTAKE ================= */
    async function stakeUSDC(amount) {
      if (!walletPublicKey) return alert("Connect wallet first");
      const res = await fetch("/api/deposit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ wallet: walletPublicKey.toBase58(), amount: Math.round(amount * 1e6) })
      });
      const data = await res.json();
      if (!data.ok) return alert(data.error);
      await syncPrivateBalance();
      alert("✅ USDC deposited privately");
    }

    async function unstakeUSDC(amount) {
      if (!walletPublicKey) return alert("Connect wallet first");
      const res = await fetch("/api/withdraw", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ wallet: walletPublicKey.toBase58(), amount: Math.round(amount * 1e6) })
      });
      const data = await res.json();
      if (!data.ok) return alert(data.error);
      await syncPrivateBalance();
      alert("✅ USDC withdrawn");
    }

    /* ================= UI BINDINGS ================= */
    document.getElementById("accountBtn").onclick = () =>
      walletPublicKey ? disconnectWallet() : connectWallet();

    document.getElementById("depositButton").onclick = () => {
      const amt = parseFloat(document.getElementById("stakeInput").value);
      if (amt > 0) stakeUSDC(amt);
    };

    document.getElementById("unstakeButton").onclick = () => {
      const amt = parseFloat(document.getElementById("unstakeInput").value);
      if (amt > 0) unstakeUSDC(amt);
    };

    /* ================= TAB TOGGLE ================= */
    document.getElementById("stakeTab").onclick = () => {
      document.getElementById("stakeSection").classList.remove("hidden");
      document.getElementById("unstakeSection").classList.add("hidden");
      document.getElementById("stakeTab").classList.add("active");
      document.getElementById("unstakeTab").classList.remove("active");
    };

    document.getElementById("unstakeTab").onclick = () => {
      document.getElementById("unstakeSection").classList.remove("hidden");
      document.getElementById("stakeSection").classList.add("hidden");
      document.getElementById("unstakeTab").classList.add("active");
      document.getElementById("stakeTab").classList.remove("active");
    };
  </script>

</body>
</html>