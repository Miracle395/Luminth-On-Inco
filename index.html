<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="stablex.png" type="image/png" sizes="16x16" />

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Manrope:wght@600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" crossorigin="anonymous" />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="luminth.css" />

  <title>A smarter way to grow your stable assets.</title>

  <style>
    .wallet-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .wallet-card {
      background: #0b0f14;
      padding: 22px;
      border-radius: 14px;
      width: 300px;
      text-align: center;
    }
    .wallet-card h4 {
      margin-bottom: 16px;
    }
    .wallet-btn {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      margin-bottom: 10px;
      border: none;
      background: #111823;
      color: #fff;
      font-weight: 500;
    }
    .wallet-btn:hover {
      background: #182233;
    }
  </style>
</head>

<body>

<!-- NAVBAR -->
<nav class="navbar navbar-dark">
  <a class="navbar-brand d-flex align-items-center" href="/">
    <img src="luminth2.png" style="width:40px" alt="Luminth Logo" />
  </a>
  <button id="accountBtn" class="account-btn">
    <span id="accountLabel">Connect Wallet</span>
  </button>
</nav>

<!-- STAKING UI (UNCHANGED) -->
<div class="page-shell">
  <section class="staking-section">
    <section class="staking-card">
      <div class="staking-toggle">
        <button id="stakeTab" class="tab active">Stake</button>
        <button id="unstakeTab" class="tab">Unstake</button>
      </div>

      <h2 class="staking-heading">Get sUSDC and Earn</h2>

      <div class="staking-form">
        <div class="form-group">
          <label>You're Staking</label>
          <div class="input-token">
            <img src="stablex.png" class="token-icon" />
            <input type="number" id="stakeInput" placeholder="0.0 USDC" />
          </div>
        </div>

        <button class="connect-btn" id="depositButton">Add funds</button>
        <button class="stake-btn" id="stakeButton" style="display:none">Stake</button>

        <p class="conversion-rate">Your sUSDC balance: <span id="sUSDCBalance">0.00</span></p>
      </div>
    </section>
  </section>
</div>

<!-- WALLET MODAL -->
<div id="walletModal" class="wallet-modal">
  <div class="wallet-card">
    <h4>Connect Wallet</h4>
    <button class="wallet-btn" onclick="selectWallet('phantom')">Phantom</button>
    <button class="wallet-btn" onclick="selectWallet('backpack')">Backpack</button>
    <button class="wallet-btn" onclick="selectWallet('solflare')">Solflare</button>
  </div>
</div>

<!-- SCRIPTS -->
<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@inco/solana-sdk@latest/dist/index.min.js"></script>

<script>
const { Connection, clusterApiUrl } = solanaWeb3;

// ================= STATE =================
let wallet = null;
let walletPublicKey = null;
let incoClient = null;

const connection = new Connection(clusterApiUrl("devnet"), "confirmed");

// ================= MODAL =================
function openWalletModal() {
  document.getElementById("walletModal").style.display = "flex";
}
function closeWalletModal() {
  document.getElementById("walletModal").style.display = "none";
}

// ================= WALLET SELECT =================
async function selectWallet(type) {
  try {
    if (type === "phantom") wallet = window.phantom?.solana;
    if (type === "backpack") wallet = window.backpack;
    if (type === "solflare") wallet = window.solflare;

    if (!wallet) return alert("Wallet not installed");

    closeWalletModal();

    await wallet.connect(); // ðŸ”¥ no return value assumed
    walletPublicKey = wallet.publicKey;

    document.getElementById("accountLabel").textContent =
      walletPublicKey.toBase58().slice(0,4) + "â€¦" +
      walletPublicKey.toBase58().slice(-4);

    await initInco();
    await syncBalance();
  } catch (e) {
    console.error(e);
    alert("Wallet connection failed");
  }
}

// ================= INCO =================
async function initInco() {
  incoClient = await IncoClient.init({
    connection,
    wallet,
    network: "devnet"
  });
}

// ================= BALANCE =================
async function syncBalance() {
  const bal = await incoClient.tokens.getBalance("USDC");
  document.getElementById("sUSDCBalance").textContent =
    (bal / 1e6).toFixed(2);
}

// ================= STAKE =================
async function stakeUSDC(amount) {
  await incoClient.tokens.deposit({
    symbol: "USDC",
    amount: Math.round(amount * 1e6)
  });
  await syncBalance();
}

// ================= UI =================
accountBtn.onclick = () => walletPublicKey ? location.reload() : openWalletModal();

stakeButton.onclick = () => {
  const amt = parseFloat(stakeInput.value);
  if (amt > 0) stakeUSDC(amt);
};

depositButton.onclick = () => {
  stakeButton.style.display = "inline-block";
  stakeInput.focus();
};
</script>

</body>
</html>